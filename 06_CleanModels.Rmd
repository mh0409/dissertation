---
title: "Untitled"
author: "Maria Jose Herrera"
date: "7/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library("tidyverse")
```

# Load data 
```{r}
df_all_postlegis <- readRDS("/Users/mariajoseherrera/Documents/LSE_new/03_Dissertation/Understanding_Society/df_all_postlegis.rds")

```

# Load categorical vars and vars of interest
```{r}
# Categorical
cat_vars <- readRDS("/Users/mariajoseherrera/Documents/LSE_new/03_Dissertation/Understanding_Society/dissertation/cat_vars.rds")

# Make sure vars are right data type
df_all_postlegis[cat_vars] <- lapply(df_all_postlegis[cat_vars], as.factor)
df_all_postlegis$wavenumber <- as.factor(df_all_postlegis$wavenumber)
df_all_postlegis$sex_dv[df_all_postlegis$sex_dv == 0] <- NA
df_all_postlegis$sex_dv <- as.factor(df_all_postlegis$sex_dv)

# Define variables of interest
vars_of_interest <- readRDS("/Users/mariajoseherrera/Documents/LSE_new/03_Dissertation/Understanding_Society/dissertation/vars_of_interest.rds")
df_interest <- select(df_all_postlegis, one_of(vars_of_interest)) # create df

# Keep only complete observations
df_interest_complete <- df_interest[complete.cases(df_interest) == TRUE, ]
# unique(df_interest_complete$hsyr04) # no NA data in df_interest_complete
# df_interest_complete <- droplevels(df_interest_complete)

summary(df_interest_complete)

df_clustervars <- df_interest_complete[, !names(df_interest_complete) %in% c("country", "pidp")] # Remove country and PIDP from data frame
```

# Select vars for model

* Locality - country ("country"), region in UK ("gor_dv"), urban or rural ("urban_dv")
* Individual - race ("racel_dv"), sex ("sex_dv"), employment status ("jbstat"), marital status ("marstat"), health
* Money/costs - total monthly income ("fihhmnnet1_dv"), monthly housing cost including mtg principal payment ("houscost1_dv")
* Other - household size ("hhsize")

```{r}
df_interest_complete$is_mtgprisoner <- as.factor(df_interest_complete$is_mtgprisoner)

unique(df_interest_complete$hsyr04) # no NA data in df_interest_complete
df_interest_complete <- droplevels(df_interest_complete)


saveRDS(df_interest_complete, "/Users/mariajoseherrera/Documents/LSE_new/03_Dissertation/Understanding_Society/df_interest_complete.rds")
```

# Recategorize 'ukborn' into yes / no
```{r}
## ukborn
df_interest_complete <- df_interest_complete %>%
    mutate(ukborn_recat = case_when(ukborn == 1 ~ 1,
                                  ukborn == 2 ~ 1,
                                  ukborn == 3 ~ 1,
                                  ukborn == 4 ~ 1,
                                  ukborn == 5 ~ 2,
                                  TRUE ~ 0))

# Make reference employed people
df_interest_complete$ukborn_recat <- as.factor(df_interest_complete$ukborn_recat)
df_interest_complete <- within(df_interest_complete, ukborn_recat <- relevel(ukborn_recat, ref = 1))

```

# log Reg Model
```{r}
glm <- glm(is_mtgprisoner ~ gor_dv + urban_dv + racel_recat + sex_dv + marstat_recat + hscost + age_dv + hiqual_dv + wavenumber + health + ukborn + hhsize, data = df_interest_complete, family = binomial)

summary(glm)
exp(glm$coefficients)
```
## Pretty Tables - Stargazer
```{r}
library("stargazer")

stargazer(df_interest_complete, type = "text")

```

## Robustness: hsyr_04

### Model
```{r}
hsyr_glm <- glm(is_mtgprisoner ~ gor_dv + urban_dv + racel_recat + sex_dv + marstat_recat + hscost + age_dv + hiqual_dv + wavenumber + hsyr04 + health + ukborn + hhsize, data = df_interest_complete, family = binomial)

summary(hsyr_glm)
exp(hsyr_glm$coefficients)

## Group them, then run model again (pre-crisis, during crisis, post-legis)
df_robust <- df_interest_complete 
df_robust$hsyr04 <- as.numeric(levels(df_robust$hsyr04))[df_robust$hsyr04]
df_robust$hsyr_group <- ifelse(df_robust$hsyr04 < 2006, 1,
                           ifelse(df_robust$hsyr04 >= 2006 & df_robust$hsyr04 < 2014, 2, 
                           ifelse(df_robust$hsyr04 >= 2014, 3, 0)))
df_robust$hsyr_group <- as.factor(df_robust$hsyr_group)

hsyr_glm2 <- glm(is_mtgprisoner ~ gor_dv + urban_dv + racel_recat + sex_dv + marstat_recat + hscost + age_dv + hiqual_dv + wavenumber + hsyr04 + health + ukborn + hhsize + hsyr_group, data = df_robust, family = binomial)

summary(hsyr_glm2)
exp(hsyr_glm2$coefficients)
```

### Table
```{r}
stargazer(glm, type = "text")
# options omit = c("coefficient name")
```

`




















